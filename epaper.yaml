# --------------------------------------------------------------------
#  ePaper Display – PowerOcean Dashboard
#  Version: 1.29
#  Änderungen:
#    - Zuflussdarstellung erweitert um vierte Zeile für den Geldwert (€)
#    - Linie (Trenner) um 20 px nach unten verschoben (nun bei y=150)
# --------------------------------------------------------------------

esphome:
  name: epaper
  friendly_name: ePaper

esp32:
  board: esp32-c3-devkitm-1
  framework:
    type: esp-idf

logger:

api:
  encryption:
    key: "JpvERJsHgGmgv6zi3tPtTDR7cXTkMIcoAQmbiOCEFxw="

ota:
  - platform: esphome
    password: "7c8ebe25a7a6df2e6666c3819e572e2b"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "Epaper Fallback Hotspot"
    password: "hCW8fSx9zqiz"

captive_portal:

font:
  - file: "gfonts://Inter@600"
    id: myFont
    size: 40

  - file: "gfonts://Inter@700"
    id: smallFont
    size: 30

  - file: "gfonts://Inter@600"
    id: tinyFont
    size: 28

text_sensor:
  - platform: homeassistant
    entity_id: sensor.powerocean_sysloadpwr
    id: SysLoadPwr
    internal: true
  - platform: homeassistant
    entity_id: sensor.powerocean_sysgridpwr
    id: SysGridPwr
    internal: true
  - platform: homeassistant
    entity_id: sensor.powerocean_bppwr
    id: BatPwr
    internal: true
  - platform: homeassistant
    entity_id: sensor.powerocean_mpptpwr
    id: PVPwr
    internal: true
  - platform: homeassistant
    entity_id: sensor.powerocean_bpsoc
    id: BatSOC
    internal: true
  - platform: homeassistant
    entity_id: sensor.powerocean_heizstab_power
    id: HeatPwr
    internal: true
  - platform: homeassistant
    entity_id: sensor.shelly_plug_mercedes_eqa_250_power
    id: EQAPwr
    internal: true
  - platform: homeassistant
    entity_id: sensor.pufferspeicher_oben
    id: WarmWasser
    internal: true
  - platform: homeassistant
    entity_id: sensor.powerocean_zeit_bis_batterie_voll
    id: ZeitBisVoll
    internal: true
  - platform: homeassistant
    entity_id: sensor.powerocean_pv1_energy_today
    id: PV1EnergyToday
    internal: true
  - platform: homeassistant
    entity_id: sensor.powerocean_pv2_energy_today
    id: PV2EnergyToday
    internal: true
  - platform: homeassistant
    entity_id: sensor.powerocean_battery_discharge_today
    id: BatDischargeToday
    internal: true
  - platform: homeassistant
    entity_id: sensor.iometer_gesamtbezug_today
    id: GridEnergyToday
    internal: true
  - platform: homeassistant
    entity_id: input_number.strompreis
    id: Strompreis
    internal: true

spi:
  clk_pin: GPIO8
  mosi_pin: GPIO10

display:
  - platform: waveshare_epaper
    cs_pin: GPIO3
    dc_pin: GPIO5
    busy_pin:
      number: GPIO4
      inverted: true
    reset_pin: GPIO2
    model: 7.50inv2
    update_interval: 30s
    lambda: |-
      auto as_int = [](const std::string &s) -> int {
        if (s.empty() || s == "unavailable" || s == "unknown" ||
            s == "None" || s == "none" || s == "nan" || s == "NaN") return 0;
        return (int) lroundf(strtof(s.c_str(), nullptr));
      };
      auto as_float = [](const std::string &s) -> float {
        if (s.empty() || s == "unavailable" || s == "unknown" ||
            s == "None" || s == "none" || s == "nan" || s == "NaN") return 0.0f;
        return strtof(s.c_str(), nullptr);
      };
      auto fmt_power = [](char *buf, int value) {
        if (abs(value) >= 1000)
          sprintf(buf, "%.2f kW", value / 1000.0f);
        else sprintf(buf, "%d W", value);
      };
      auto clamp = [](int v){ return std::min(100, std::max(0, v)); };

      // --- Zeichenbreiten-LUT (wie in 1.28) ---
      auto tiny_char_width = [](char c) -> int {
        switch (c) {
          case '0': case '8': case '9': return 15;
          case '1': return 11;
          case '2': case '3': case '4':
          case '5': case '6': case '7': return 14;
          case 'A': case 'B': case 'D': case 'E':
          case 'H': case 'K': case 'N': case 'R':
          case 'U': case 'V': case 'X': case 'Y': case 'Z': return 16;
          case 'C': case 'G': case 'O': case 'Q': return 17;
          case 'F': case 'L': case 'P': case 'S': case 'T': return 15;
          case 'I': case 'J': return 11;
          case 'M': case 'W': return 19;
          case 'a': case 'c': case 'e': case 'o': return 13;
          case 'b': case 'd': case 'g': case 'h':
          case 'n': case 'p': case 'q': case 'u': return 14;
          case 'i': case 'j': return 8;
          case 'k': case 'r': case 's': case 't': return 12;
          case 'l': return 7;
          case 'm': return 18;
          case 'v': case 'x': return 13;
          case 'w': return 17;
          case 'y': case 'z': return 12;
          case '(': case ')': return 10;
          case '.': case ',': return 7;
          case ':': return 7;
          case ' ': return 8;
          default: return 14;
        }
      };
      auto tiny_text_width = [&](const std::string &s) -> int {
        int sum = 0;
        for (char c : s) sum += tiny_char_width(c);
        return sum;
      };

      // ---- Werte laden ----
      int vPV = as_int(id(PVPwr).state);
      int vGrid = as_int(id(SysGridPwr).state);
      int vBat = as_int(id(BatPwr).state);
      float vPV1Today = as_float(id(PV1EnergyToday).state);
      float vPV2Today = as_float(id(PV2EnergyToday).state);
      float vBatDisToday = as_float(id(BatDischargeToday).state);
      float vGridToday = as_float(id(GridEnergyToday).state);
      float vPrice = as_float(id(Strompreis).state);

      int vBatMinus = (vBat < 0) ? -vBat : 0;
      int vBezug = (vGrid > 0) ? vGrid : 0;
      int pv_pct = clamp((int) lroundf((vPV / 12600.0f) * 100.0f));

      float pv_today = vPV1Today + vPV2Today;
      float pv_value = pv_today * vPrice;
      float bat_today = vBatDisToday;
      float bat_value = bat_today * vPrice;
      float grid_today = vGridToday;
      float grid_value = grid_today * vPrice;

      char sPV[20], sBezug[20], sBat[20];
      fmt_power(sPV, vPV);
      fmt_power(sBezug, vBezug);
      fmt_power(sBat, vBatMinus);

      const int screen_w = 800;
      const int cw_big = 18;

      // ---- Zufluss mit 4 Zeilen ----
      int inflow_count = 3;
      int seg_w = screen_w / inflow_count;
      const int yLabel = 10;
      const int yPower = 40;
      const int yEnergy = 80;
      const int yValue = 110;

      auto draw_inflow = [&](int idx, const char* label,
                             const char* power, float energy, float euros) {
        int cx = idx * seg_w + seg_w / 2;
        char line1[40], line2[40];
        sprintf(line1, "%.2f kWh", energy);
        sprintf(line2, "(%.2f €)", euros);
        int lbl_px = tiny_text_width(label);
        int pwr_px = strlen(power) * cw_big;
        int e_px = tiny_text_width(line1);
        int val_px = tiny_text_width(line2);

        it.printf(cx - lbl_px/2, yLabel, id(tinyFont), "%s", label);
        it.printf(cx - pwr_px/2, yPower, id(myFont), "%s", power);
        it.printf(cx - e_px/2, yEnergy, id(tinyFont), "%s", line1);
        it.printf(cx - val_px/2, yValue, id(tinyFont), "%s", line2);
      };

      draw_inflow(0, "Solar", sPV, pv_today, pv_value);
      draw_inflow(1, "Netz", sBezug, grid_today, grid_value);
      draw_inflow(2, "Batterie", sBat, bat_today, bat_value);

      // Linie etwas tiefer
      it.filled_rectangle(10, 150, 780, 5);
